<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TCM Dashboard - Index</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #f7f7f7; margin: 0; }
      .container { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
      .card { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 16px; }
      .row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-top: 16px; }
      .metric { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 16px; }
      .metric .label { font-size: 13px; color: #666; }
      .metric .value { font-size: 26px; font-weight: 700; margin-top: 6px; }
      .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 12px; }
      input, button { height: 38px; padding: 0 10px; border-radius: 8px; border: 1px solid #ddd; }
      button { background: #0d6efd; color: #fff; border: none; cursor: pointer; }
      button.secondary { background: #6c757d; }
      button:disabled { opacity: .6; cursor: not-allowed; }
      .muted { color: #777; font-size: 12px; margin-top: 8px; }
      .error { color: #b00020; margin-top: 8px; }
      .ok { color: #0a7f2e; }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>TCM - Dashboard Index</h2>

      <div class="card">
        <div class="controls">
          <input id="apiUrl" placeholder="API URL" />
          <input id="email" placeholder="Email" />
          <input id="password" placeholder="Password" type="password" />
        </div>
        <div class="controls">
          <button id="btnLogin">Login & Save Token</button>
          <button id="btnSummary" class="secondary">Fetch Summary</button>
          <button id="btnLogout" class="secondary">Clear Token</button>
        </div>
        <div id="status" class="muted"></div>
      </div>

      <div class="row" id="grid" style="display:none">
        <div class="metric"><div class="label">Người cao tuổi</div><div class="value" id="mElders">-</div></div>
        <div class="metric"><div class="label">Nhân sự</div><div class="value" id="mStaff">-</div></div>
        <div class="metric"><div class="label">Cảnh báo mở</div><div class="value" id="mOpen">-</div></div>
        <div class="metric"><div class="label">Cảnh báo nghiêm trọng</div><div class="value" id="mCritical">-</div></div>
        <div class="metric"><div class="label">Sinh hiệu 24h</div><div class="value" id="mVitals">-</div></div>
      </div>

      <div id="updated" class="muted"></div>

      <div id="error" class="error"></div>
    </div>

    <script>
      const apiUrl = document.getElementById('apiUrl');
      const email = document.getElementById('email');
      const password = document.getElementById('password');
      const btnLogin = document.getElementById('btnLogin');
      const btnSummary = document.getElementById('btnSummary');
      const btnLogout = document.getElementById('btnLogout');
      const status = document.getElementById('status');
      const grid = document.getElementById('grid');
      const updated = document.getElementById('updated');
      const errBox = document.getElementById('error');

      const mElders = document.getElementById('mElders');
      const mStaff = document.getElementById('mStaff');
      const mOpen = document.getElementById('mOpen');
      const mCritical = document.getElementById('mCritical');
      const mVitals = document.getElementById('mVitals');

      // Defaults
      apiUrl.value = localStorage.getItem('apiUrl') || 'http://localhost:3000';
      const savedToken = localStorage.getItem('accessToken');
      if (savedToken) {
        status.innerHTML = 'Token available';
        status.classList.add('ok');
      }

      function setBusy(b) {
        btnLogin.disabled = b; btnSummary.disabled = b; btnLogout.disabled = b;
      }

      btnLogin.addEventListener('click', async () => {
        errBox.textContent = '';
        status.textContent = '';
        setBusy(true);
        try {
          localStorage.setItem('apiUrl', apiUrl.value);
          const res = await fetch(`${apiUrl.value}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email.value, password: password.value })
          });
          if (!res.ok) throw new Error(`Login failed: HTTP ${res.status}`);
          const data = await res.json();
          if (!data.accessToken) throw new Error('No accessToken in response');
          localStorage.setItem('accessToken', data.accessToken);
          status.textContent = `Login OK. User: ${data.user?.fullName || data.user?.email || ''}`;
          status.classList.add('ok');
        } catch (e) {
          errBox.textContent = e.message || String(e);
        } finally { setBusy(false); }
      });

      btnSummary.addEventListener('click', async () => {
        errBox.textContent = '';
        status.textContent = '';
        setBusy(true);
        try {
          const token = localStorage.getItem('accessToken') || '';
          const res = await fetch(`${apiUrl.value}/api/dashboard/summary`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error(`Summary failed: HTTP ${res.status}`);
          const s = await res.json();
          mElders.textContent = s.totalElders ?? '-';
          mStaff.textContent = s.totalStaff ?? '-';
          mOpen.textContent = s.openAlerts ?? '-';
          mCritical.textContent = s.criticalAlerts ?? '-';
          mVitals.textContent = s.recentVitals ?? '-';
          updated.textContent = s.lastUpdated ? `Cập nhật: ${new Date(s.lastUpdated).toLocaleString()}` : '';
          grid.style.display = 'grid';
        } catch (e) {
          errBox.textContent = e.message || String(e);
        } finally { setBusy(false); }
      });

      btnLogout.addEventListener('click', () => {
        localStorage.removeItem('accessToken');
        status.textContent = 'Token cleared.';
        status.classList.remove('ok');
      });
    </script>
  </body>
  </html>


